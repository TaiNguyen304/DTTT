<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contestant Interface</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: white;
            color: black;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 16px;
        }

        .login-card,
        .ready-card {
            background: white;
            width: 100%;
            max-width: 450px;
            padding: 32px;
            border-radius: 16px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            text-align: center;
        }

        .form-control {
            width: 100%;
            padding: 14px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: bold;
            margin-bottom: 16px;
            outline: none;
        }

        .btn {
            border: none;
            cursor: pointer;
            border-radius: 8px;
            padding: 12px;
            font-weight: bold;
            font-size: 1rem;
            width: 100%;
            transition: all 0.2s;
        }

        .btn-primary {
            background-color: purple;
            color: white;
        }

        .btn-success {
            background-color: green;
            color: white;
            padding: 20px;
            font-size: 1.2rem;
        }

        .btn:hover {
            background-color: orange;
            color: white;
        }

        #mainSection,
        #readySection {
            display: none;
            width: 100%;
            max-width: 1200px;
            flex-direction: column;
            align-items: center;
        }

        .info-bar {
            width: 100%;
            background: yellow;
            color: black;
            padding: 16px;
            border-radius: 12px;
            display: flex;
            justify-content: space-between;
            margin-bottom: 24px;
        }

        .video-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            width: 100%;
        }

        .video-container {
            position: relative;
            background: #000;
            border-radius: 8px;
            overflow: hidden;
            border: 3px solid transparent;
            cursor: pointer;
            aspect-ratio: 16/9;
        }

        .video-container.active {
            border-color: blue;
        }

        .topic-label {
            background: #333;
            color: white;
            padding: 8px;
            text-align: center;
            font-weight: bold;
            min-height: 40px;
        }

        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            background: black;
        }

        .red-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: red;
            z-index: 10;
            display: none;
        }

        .video-container.masked .red-overlay {
            display: flex;
        }

        .mute-btn {
            position: absolute;
            bottom: 10px;
            right: 10px;
            z-index: 20;
            background: rgba(255, 0, 0, 0.8);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            font-weight: bold;
            cursor: pointer;
        }

        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 999;
        }

        .popup-card {
            background: white;
            padding: 24px;
            border-radius: 16px;
            width: 320px;
            text-align: center;
        }
    </style>
</head>

<body>
    <input type="hidden" id="supabaseUrl" value="https://lohkwsuebmgscgmwvyqv.supabase.co">
    <input type="hidden" id="supabaseKey"
        value="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxvaGt3c3VlYm1nc2NnbXd2eXF2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQyNzk0MzksImV4cCI6MjA3OTg1NTQzOX0.D5ZNvCsqTZRXu0EpkM8BiIvX2V-PzjK0uVur6KERfhk">

    <div id="loginSection" class="login-card">
        <h1 style="margin-bottom: 20px;">Đăng nhập Thí sinh</h1>
        <input type="text" id="loginRoom" placeholder="Mã phòng" class="form-control">
        <input type="text" id="loginUser" placeholder="Tên hiển thị" class="form-control">
        <button onclick="joinRoom()" class="btn btn-primary">Tham gia</button>
    </div>

    <div id="readySection" class="ready-card">
        <h2 style="margin-bottom: 15px;">Kết nối thành công!</h2>
        <p style="margin-bottom: 20px; color: #666;">Vui lòng bấm nút dưới đây để cấp quyền phát video tự động từ Host.
        </p>
        <button onclick="readyToPlay()" class="btn btn-success">TÔI ĐÃ SẴN SÀNG</button>
    </div>

    <div id="mainSection">
        <div class="info-bar">
            <span style="font-weight: bold;">PHÒNG: <b id="displayRoomId">---</b></span>
            <span id="displayUser" style="font-weight: bold;">---</span>
        </div>

        <div class="video-grid">
            <div id="wrapper0" class="video-container" onclick="focusVideo(0)">
                <div id="topic0" class="topic-label">Đang chờ...</div>
                <video id="video0" playsinline muted></video>
                <div class="red-overlay"></div>
                <button onclick="toggleMute(0, event)" id="mute0" class="mute-btn">BẬT ÂM THANH</button>
            </div>
            <div id="wrapper1" class="video-container" onclick="focusVideo(1)">
                <div id="topic1" class="topic-label">Đang chờ...</div>
                <video id="video1" playsinline muted></video>
                <div class="red-overlay"></div>
                <button onclick="toggleMute(1, event)" id="mute1" class="mute-btn">BẬT ÂM THANH</button>
            </div>
            <div id="wrapper2" class="video-container" onclick="focusVideo(2)">
                <div id="topic2" class="topic-label">Đang chờ...</div>
                <video id="video2" playsinline muted></video>
                <div class="red-overlay"></div>
                <button onclick="toggleMute(2, event)" id="mute2" class="mute-btn">BẬT ÂM THANH</button>
            </div>
        </div>
    </div>

    <div id="msgPopup" class="popup-overlay">
        <div class="popup-card">
            <p id="msgContent" style="font-weight: bold; margin-bottom: 24px;"></p>
            <button onclick="closePopup('msgPopup')" class="btn btn-primary">Đóng</button>
        </div>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.44.2/+esm';

        const supabaseUrl = document.getElementById('supabaseUrl').value;
        const supabaseKey = document.getElementById('supabaseKey').value;
        const supabase = createClient(supabaseUrl, supabaseKey);

        let currentUser = { uid: "contestant-" + Math.random().toString(36).substring(2, 9) };
        let currentRoomId = null;
        let lastStatusTimestamp = 0;

        // Xử lý đăng nhập
        window.joinRoom = async () => {
            const roomId = document.getElementById('loginRoom').value;
            const username = document.getElementById('loginUser').value;
            if (!roomId || !username) return showMessage("Vui lòng nhập đủ thông tin");

            const { data: room } = await supabase.from('rooms').select('data').eq('id', roomId).single();
            if (!room) return showMessage("Phòng không tồn tại");

            const currentData = room.data;
            currentData.participants.push({ name: username, role: "Thí sinh", id: currentUser.uid, last_active: Date.now() });
            await supabase.from('rooms').update({ data: currentData }).eq('id', roomId);

            currentRoomId = roomId;
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('readySection').style.display = 'flex'; // Chuyển sang màn hình Sẵn sàng
            document.getElementById('displayRoomId').innerText = roomId;
            document.getElementById('displayUser').innerText = username;
        };

        // Kích hoạt quyền Media (Quan trọng nhất)
        window.readyToPlay = async () => {
            // Mồi trình duyệt để cho phép autoplay sau này
            for (let i = 0; i < 3; i++) {
                const v = document.getElementById(`video${i}`);
                v.play().then(() => v.pause()).catch(e => console.log("Unlock video:", i));
            }

            document.getElementById('readySection').style.display = 'none';
            document.getElementById('mainSection').style.display = 'flex';
            listenToRoom(currentRoomId);
        };

        window.focusVideo = (index) => {
            for (let i = 0; i < 3; i++) {
                const el = document.getElementById(`wrapper${i}`);
                if (i === index) {
                    el.classList.remove('masked');
                    el.classList.add('active');
                } else {
                    el.classList.add('masked');
                    el.classList.remove('active');
                }
            }
        };

        window.toggleMute = (index, event) => {
            if (event) event.stopPropagation();
            const v = document.getElementById(`video${index}`);
            v.muted = !v.muted;
            document.getElementById(`mute${index}`).innerText = v.muted ? "BẬT ÂM THANH" : "TẮT ÂM THANH";
        };

        function listenToRoom(roomId) {
            supabase.channel(`room_${roomId}`)
                .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'rooms', filter: `id=eq.${roomId}` }, (payload) => {
                    const data = payload.new.data;

                    // 1. Cập nhật URL & Chủ đề
                    if (data.round2Videos && data.round2Videos.length > 0) {
                        data.round2Videos.forEach((videoData, i) => {
                            const v = document.getElementById(`video${i}`);
                            const t = document.getElementById(`topic${i}`);

                            if (data.status.showTopic && data.status.showTopic[i]) {
                                t.innerText = videoData.topic;
                            }

                            if (videoData.url && v.getAttribute('data-loaded-url') !== videoData.url) {
                                v.src = videoData.url;
                                v.setAttribute('data-loaded-url', videoData.url);
                                v.muted = true; // Luôn bắt đầu bằng muted
                                v.load();
                            }
                        });
                    }

                    // 2. Lệnh phát video đồng loạt từ Host
                    if (data.status && data.status.isPlaying === true && data.status.timestamp !== lastStatusTimestamp) {
                        lastStatusTimestamp = data.status.timestamp;

                        for (let i = 0; i < 3; i++) {
                            const v = document.getElementById(`video${i}`);
                            if (v.src) {
                                v.muted = true; // Chrome bắt buộc muted để autoplay
                                v.play().catch(err => console.error("Phát video thất bại:", err));
                            }
                        }
                    }
                }).subscribe();
        }

        window.closePopup = (id) => document.getElementById(id).style.display = 'none';
        window.showMessage = (msg) => { document.getElementById('msgContent').innerText = msg; document.getElementById('msgPopup').style.display = 'flex'; };
    </script>
</body>

</html>